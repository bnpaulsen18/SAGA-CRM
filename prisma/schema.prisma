// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// CORE MODELS
// ========================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  ein       String   @unique
  email     String
  phone     String?
  website   String?

  // Hierarchical Structure - For Fiscal Sponsorship / Parent-Project relationships
  organizationType   OrganizationType @default(INDEPENDENT)
  parentOrganizationId String?

  // Nonprofit Compliance Fields
  taxExemptStatus    TaxExemptStatus  @default(EXEMPT_501C3)
  fiscalYearEnd      String?          // Format: "MM-DD" (e.g., "12-31")
  missionStatement   String?
  primaryProgram     String?

  // Settings
  allowSubProjects   Boolean          @default(false) // Can this org create sub-projects?

  // Stripe Connect for payment processing
  stripeConnectAccountId String? @unique // Stripe Connect account ID for receiving donations
  stripeConnectStatus    StripeConnectStatus @default(NOT_CONNECTED)
  stripeConnectError     String? // Error message if connection failed

  // Subscription & Billing
  subscriptionTier       SubscriptionTier @default(FREE)
  subscriptionStatus     SubscriptionStatus @default(ACTIVE)
  stripeCustomerId       String? @unique // Platform subscription billing (not Connect)
  trialEndsAt            DateTime? // Pro/Enterprise free trial expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  users        User[]
  contacts     Contact[]
  donations    Donation[]
  campaigns    Campaign[]
  emails       Email[]
  interactions Interaction[]
  tasks        Task[]

  // Hierarchical relationships
  parentOrganization Organization?  @relation("OrgHierarchy", fields: [parentOrganizationId], references: [id])
  subProjects        Organization[] @relation("OrgHierarchy")

  // Donations designated for this project (when this is a sub-project)
  designatedDonations Donation[] @relation("DesignatedProject")

  @@index([parentOrganizationId])
  @@map("organizations")
}

enum OrganizationType {
  INDEPENDENT   // Standalone nonprofit
  PARENT        // Fiscal sponsor / Parent org with sub-projects
  PROJECT       // Sub-project under a parent org
}

enum TaxExemptStatus {
  EXEMPT_501C3       // Public charity
  EXEMPT_501C4       // Social welfare
  EXEMPT_501C6       // Business league
  EXEMPT_501C7       // Social club
  EXEMPT_OTHER       // Other tax-exempt
  FOR_PROFIT         // Not tax-exempt (rare but possible for projects)
  PENDING            // Application pending
}

enum StripeConnectStatus {
  NOT_CONNECTED      // No Stripe account connected
  PENDING            // OAuth started but not completed
  CONNECTED          // Successfully connected and verified
  ERROR              // Connection failed or disconnected
  RESTRICTED         // Stripe flagged account (needs review)
}

enum SubscriptionTier {
  FREE               // Up to 500 contacts, manual donations only
  PRO                // $99/mo + 2% donations, unlimited features
  ENTERPRISE         // $199/mo + 2% donations, advanced features
}

enum SubscriptionStatus {
  ACTIVE             // Subscription active and paid
  TRIAL              // In free trial period
  PAST_DUE           // Payment failed, grace period
  CANCELED           // Subscription canceled
  PAUSED             // Temporarily paused
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String
  firstName      String
  lastName       String
  role           UserRole @default(MEMBER)
  organizationId String?  // Nullable for PLATFORM_ADMIN users

  // NextAuth fields
  emailVerified  DateTime?
  image          String?

  // Platform Admin Settings
  isPlatformAdmin Boolean @default(false) // Redundant with role, but useful for quick checks

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relationships
  organization Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  interactions Interaction[]
  tasks        Task[]
  accounts     Account[]
  sessions     Session[]
  auditLogs    AuditLog[]

  @@index([organizationId])
  @@index([role])
  @@map("users")
}

enum UserRole {
  PLATFORM_ADMIN  // SAGA platform owner - can access all organizations
  ADMIN           // Organization admin - full access within org + sub-projects
  MEMBER          // Regular user - access to assigned org only
  VIEWER          // Read-only access
}

// ========================================
// CONTACT MANAGEMENT
// ========================================

model Contact {
  id             String @id @default(cuid())
  organizationId String

  // Basic Info
  firstName String
  lastName  String
  email     String
  phone     String?

  // Address
  street  String?
  city    String?
  state   String?
  zip     String?
  country String  @default("USA")

  // Contact Type
  type   ContactType   @default(DONOR)
  status ContactStatus @default(ACTIVE)

  // Metadata
  tags  String[]
  notes String?

  // Relationships
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  donations        Donation[]
  interactions     Interaction[]
  campaignContacts CampaignContact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([email])
  @@map("contacts")
}

enum ContactType {
  DONOR
  VOLUNTEER
  BOARD_MEMBER
  STAFF
  VENDOR
  OTHER
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  DECEASED
  DO_NOT_CONTACT
}

// ========================================
// DONATIONS
// ========================================

model Donation {
  id             String  @id @default(cuid())
  organizationId String
  contactId      String
  campaignId     String?

  // Donation Details
  amount   Float
  currency String         @default("USD")
  type     DonationType   @default(ONE_TIME)
  method   PaymentMethod  @default(CREDIT_CARD)
  status   DonationStatus @default(COMPLETED)

  // Payment Info
  transactionId String?
  receiptNumber String? @unique
  idempotencyKey String? @unique // Prevents duplicate charges (Stripe best practice)

  // Tax Receipt
  taxDeductible Boolean   @default(true)
  receiptSent   Boolean   @default(false)
  receiptSentAt DateTime?

  // Fund Accounting & Restrictions (IRS Compliance)
  fundRestriction   FundRestriction @default(UNRESTRICTED)
  designatedProjectId String?       // If donor restricts gift to specific project
  donorIntent       String?         // Specific donor restrictions or instructions

  // Fiscal Sponsorship Tracking
  passedThroughToProject Boolean @default(false) // Has parent org disbursed to project?
  disbursedAt            DateTime?               // When funds were passed through

  // Fraud Detection & Risk Assessment
  fraudScore         Int?     @default(0)   // 0-100 risk score (0=safe, 100=high risk)
  fraudFlags         String[] @default([])  // Array of risk factors detected
  reviewStatus       ReviewStatus @default(APPROVED) // Manual review status
  reviewedAt         DateTime?
  reviewedBy         String?  // User ID who reviewed

  // Metadata
  notes              String?
  acknowledgmentSent Boolean @default(false)

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  campaign     Campaign?    @relation(fields: [campaignId], references: [id])

  // Project designation for fiscal sponsorship
  designatedProject Organization? @relation("DesignatedProject", fields: [designatedProjectId], references: [id])

  donatedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([contactId])
  @@index([campaignId])
  @@index([donatedAt])
  @@index([designatedProjectId])
  @@index([fundRestriction])
  @@index([reviewStatus])
  @@index([fraudScore])
  @@index([idempotencyKey])
  @@map("donations")
}

enum FundRestriction {
  UNRESTRICTED        // No donor restrictions - org can use freely
  TEMPORARILY_RESTRICTED  // Time or purpose restricted (e.g., "for 2025 programs")
  PERMANENTLY_RESTRICTED  // Endowment - principal can't be spent
  PROGRAM_RESTRICTED     // Restricted to specific program
  PROJECT_DESIGNATED     // Donor designated for specific sub-project
}

enum DonationType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  ANNUAL
  IN_KIND
  STOCK
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CHECK
  CASH
  PAYPAL
  VENMO
  CRYPTOCURRENCY
  OTHER
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum ReviewStatus {
  APPROVED       // Donation passed all fraud checks
  PENDING_REVIEW // Flagged for manual review
  REJECTED       // Marked as fraudulent
  REFUNDED       // Was valid but refunded
}

// ========================================
// CAMPAIGNS
// ========================================

model Campaign {
  id             String @id @default(cuid())
  organizationId String

  // Campaign Details
  name        String
  description String?
  goal        Float?
  raised      Float   @default(0)

  // Status & Dates
  status    CampaignStatus @default(DRAFT)
  startDate DateTime?
  endDate   DateTime?

  // Metadata
  tags String[]

  // Relationships
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  donations        Donation[]
  campaignContacts CampaignContact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

model CampaignContact {
  id         String @id @default(cuid())
  campaignId String
  contactId  String

  // Contact's participation
  role String?

  campaign  Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact   Contact  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@map("campaign_contacts")
}

// ========================================
// EMAIL COMMUNICATIONS
// ========================================

model Email {
  id             String @id @default(cuid())
  organizationId String

  // Email Details
  subject String
  body    String
  from    String

  // Status
  status       EmailStatus @default(DRAFT)
  scheduledFor DateTime?
  sentAt       DateTime?

  // Recipients
  recipients EmailRecipient[]

  // Metadata
  tags String[]

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@map("emails")
}

enum EmailStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

model EmailRecipient {
  id        String @id @default(cuid())
  emailId   String
  contactId String

  // Tracking
  sent    Boolean @default(false)
  opened  Boolean @default(false)
  clicked Boolean @default(false)
  bounced Boolean @default(false)

  sentAt    DateTime?
  openedAt  DateTime?
  clickedAt DateTime?

  email     Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([emailId])
  @@index([contactId])
  @@map("email_recipients")
}

// Email Log for tracking individual email sends (receipts, thank-yous, etc.)
model EmailLog {
  id             String  @id @default(cuid())
  organizationId String
  contactId      String?
  donationId     String?

  // Email Details
  to      String
  subject String
  status  String  @default("SENT") // SENT, FAILED, BOUNCED

  // Tracking
  messageId String? // External email provider ID (e.g., Resend)
  sentAt    DateTime
  openedAt  DateTime?

  // Metadata
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([contactId])
  @@index([donationId])
  @@map("email_logs")
}

// ========================================
// INTERACTIONS
// ========================================

model Interaction {
  id             String @id @default(cuid())
  organizationId String
  contactId      String
  userId         String

  // Interaction Details
  type    InteractionType
  subject String
  notes   String?

  // Date/Time
  occurredAt DateTime @default(now())

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([contactId])
  @@index([userId])
  @@map("interactions")
}

enum InteractionType {
  NOTE
  CALL
  MEETING
  EMAIL_SENT
  EMAIL_RECEIVED
  DONATION_RECEIVED
  EVENT_ATTENDED
  OTHER
}

// ========================================
// TASK MANAGEMENT
// ========================================

model Task {
  id             String  @id @default(cuid())
  organizationId String
  userId         String
  contactId      String?

  // Task Details
  title       String
  description String?
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus   @default(TODO)

  // Due Date
  dueDate     DateTime?
  completedAt DateTime?

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ========================================
// NEXTAUTH MODELS
// ========================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========================================
// AUDIT LOG (GDPR Compliance)
// ========================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String   // "CREATE", "UPDATE", "DELETE", "VIEW", "EXPORT", "GDPR_DELETE"
  resource   String   // "Contact", "Donation", "Campaign", etc.
  resourceId String?
  metadata   Json?    // Store changed fields, IP address, user agent, etc.
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resource, resourceId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}

// ========================================
// EMAIL NEWSLETTER SUBSCRIBERS
// ========================================

model EmailSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  source    String   @default("landing_page") // landing_page, footer, popup, etc.
  status    SubscriberStatus @default(PENDING)

  // Verification
  verificationToken String?  @unique
  verifiedAt        DateTime?

  // Preferences
  unsubscribedAt    DateTime?
  unsubscribeToken  String?   @unique

  // Metadata
  ipAddress         String?
  userAgent         String?
  referrer          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("email_subscribers")
}

enum SubscriberStatus {
  PENDING      // Email submitted, awaiting verification
  ACTIVE       // Verified and subscribed
  UNSUBSCRIBED // Opted out
  BOUNCED      // Email bounced
  COMPLAINED   // Marked as spam
}
